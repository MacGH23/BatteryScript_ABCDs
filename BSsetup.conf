[Setup]
# Change to 1 if you setup everything and accept the discalaimer
# THERE IS NO GURANTEE FOR AN ERROR FREE EXECUTION
# YOU TAKE THE 100% RISK IF YOU USE THIS SCRIPT !!!
#
# ONLY FOR USE WITH LIFEPO4 CELLS !!! 
# BATTERIES CAN BE DANGEROUS      !!! 
# CHECK ALL PARAMETERS CAREFULLY !!!
#
# IMPORTANT NOTES !!
#
# DO NOT UPDATE THE METER VALUES LESS THAN 2 SECONDS !
# 
# OTHERWISE THE SCRIPT CAN HANGUP OR THE HARDWARE CAN DECREASE FASTER !
# 
# FOR MEANWELL DEVCIES CHANGE "MeterUpdateCounter" BELOW, SEE EXPLANATION ! 
i_changed_my_config       = 0

# Enter Loglevel 0,10,20,30,40,50 
# CRITICAL   50
# ERROR      40
# WARNING    30
# INFO       20
# DEBUG      10
# NOTSET      0
loglevel                  = 20
logpath                   = /home/pi/bs.log
logtoconsole              = 1
logtofile                 = 0
logappendfile             = 0

#You can log to syslog, but this can be a lot of data !
#Should be used when run as a service after fully tested with your envirnment and loglevel set to warning
logtosyslog               = 0

##########################################################################
# LCD setup 
# 0 = Disabled
# 1 = LCD 2x16 to 4x20, init with 4x20, but you can take care about how many lines you use
Selected_LCD   = 0
#lcd i2c adr in int format 0x27 = 39
lcdi2cadr      = 39

##########################################################################
# GPIO setup 
# Note: You have to program the result of the button press on your own
# GPIO section is in the beginning of the script
# 0 = Disabled
# 1 = Enabled
# GPIO PIN Nr. in BCM format
Use_GPIO = 0
# GPIO PIN = 0 = not used
gpio1 = 17
gpio2 = 27
gpio3 = 22
gpio4 = 0

### BMS USD ##############################################################
# Software calculate the SOC form DC voltage from BatteryVoltageSource (see below)
# DISABLED  = 0
# Software  = 1 #not fully implemented 
# JKBMS     = 2
Selected_BMS = 0
#Discharge until ..., -1 = Don't check BMS SOC Level at all, let BMS/Voltage controll the stoping
#Check if your BMS SOC Value matches the real SOC, otherwise use only Voltages
BMSminSOC = 0
bms_device = /dev/ttyAMA0

### Battery DC voltage read ##############################################################
# Which device should be used for Batetry DC Voltage read
# 0 = Disabled, let the BMS,Discharger, ... handle the stop/start
# DISABLED    = 0  
# BMS         = 1
# Charger     = 2
# Discharger  = 3
BatteryVoltageSource = 2

# If the reading of the DC voltage is not correct, you can adjust it +/- value in *100 value 
# 0,15V = 0,15*100 = 15
BatteryVoltageCorrection = 0

##########################################################################
# Measurements for calculating Dis-Charge power average of power event (smooth the power outpot)
#0=forbidden ;-)
#1=just use the actual power value
#2=average of 2 power events
#3=...
powercalccount = 8

# Select the method to control the charger / discharger
# see "def process_power(val)" --> in the script !!
# you can use the already implemneted or implement your own
# 0   = DISABLED - only for debug do not use
# 1   = Universal simple Charge / Discharge method
# 255 = Simulator
PowerControlmethod = 1

### USED CHARGER #########################################################
# BIC-2200 = 0
# NPM-abc0 = 1
# Simulator = 255
Selected_Device_Charger = 1

### USED DISCHARGER ######################################################
# BIC-2200  = 0
# Lumentree = 1
# Simulator = 255
Selected_Device_DisCharger = 1

###########################################################################
#### M E T E R  /  M Q T T ################################################
###########################################################################
# If you want to stop the charger if connection to meter is lost 
# to prevent overcharge or costs
StopOnConnectionLost = 1

# select where the power value should be read
# 0   = mqtt - get the WATT value from mqtt Server (e.g. iobroker)
# 1   = http - get WATT value from webserver ESP32 with Tasmota see options below
# 255 = Simulator (send a random +/- value)
GetPowerOption  = 0


# which http request should be used
# IP and port
# 0 = not used !
# 1 = Shelly EM
# 2 = Shelly 3EM
# 3 = Shelly 3EMPro
# 4 = Shelly TASMOTA
# 5 = Shelly SHRDZM
# 6 = Shelly EMLOG
# 7 = Shelly IOBROKER SIMPLE API
# 8 = NOT implemented now ! Shelly HOMEASSISTANT 
# 9 = Shelly VZLOGGER
http_get_option       = 7
http_ip_address       = 192.168.2.8
http_ip_port          = 8087
http_user             = NONE
http_pass             = NONE
http_emlog_meterindex = 0
http_vzl_UUID         = NONE
http_iobrogerobject   = CurrentPower[change to your object]

#http Request option
#after x seconds get new power value
#do not use less than 2 !
http_schedule_time = 2

#mqtt settings for your MQTT server
# 
mqttserver= 192.168.178.100
mqttport  = 1883
mqttuser  = mqttuser
mqttpass  = mqttpassword
#IMPORTANT
#The subscription topic must have the power in WATT (+ and -) 
#positiv = from Grid, negative = from Solar/Battery
#mqttsubcribe = smartmeter/0/1-0:16_7_0__255/value
mqttsubscribe = 0_userdata.0.CurrentPower

#mqttPublish value to broker
mqttpublish         = 0
#empty string = do not use
mqttpublishWATT     = Battery/Status/Watt
mqttpublishSOC      = Battery/Status/BatterySOC
mqttpublishBatVolt  = Battery/Status/BatteryVoltage


##########################################################################
#### ( D I S ) - C H A R G E R - C O N F I G #############################
##########################################################################
#General info, details also set in sections of the charger
#Min Watt what the charger can provide, see datasheet
MinChargeWATT              =     0  

#Max Watt what the charger can provide, see datasheet
MaxChargeWATT              =  1000  

#LastInverterPower hyteresis, dont change the output if new value in this range (+ and -)
LastChargePower_delta      =    20  

#How much Watt the discharger / Inverter can provide.
#Check for Lumentree what is the real max output at max set. At 24V the output is lower beause of limited current
#Lumentree 600 @ 24V has only 570W max !
#If you have more than 1 installed, this value must be the total of all installed discharger !
#NOTE: For Lumentree it is calculated by the values you specify in the Lumentree ltx_maxwatt section !
MaxDisChargeWATT           =   570  

#Min Watt what the discharger / Inverter can provide, normally 0; Lumentree 600 = 27W --> use 28 to be sure ;-)
MinDisChargeWATT           =    28  

#LastInverterPower hyteresis, dont change the output if new value in this range (+ and -)
LastDisChargePower_delta   =    15  

#Reduce x Watt from Discharger output to prevent output to GRID 
ZeroDeltaDisChargeWATT     =    15  

#Allow take power the from grid to charge with Min. if Min. > actual power
#not implemented now
ZeroDeltaChargerWatt       =    0

# How much Meter changes count before change output
# #### IMPORTANT FOR MEANWELL ####
# Important since meanwell are limited to power changes to 4.000.000 writes
# 4.000.000 / 10 (years) / 365 (days) / 8 (hours sun) / 60 (min) = 2,3 changes / min for 10 year
# 60 / 2,3 = every 26 seconds.
# since there will be no changes if the same value (in the range above) or max value, 
# I guess every 15 seconds should be OK for min. 10 years
# METER should not update more than 2 seconds, please adjust the value accordingliy ! 
MeterUpdateCounter = 8


##########################################################################
# Lumentree / Trucki parameters ##########################################
##########################################################################
# If a lumentree is installed but you want to use an other Device or simualtor, 
# the lumentree will start at max power during startup, this will prevent this
# Power in WATT ! 
# 570W = 570				  
lt_foreceoffonstartup    = 1

#How much Lumentree devices you have installed. Max is 3
lt_count    = 1

#select the right device and values for each Lumentree
lt1_device  = /dev/ttyUSB0
lt1_address = 1
lt1_maxwatt = 570

lt2_device  = 
lt2_address = 1
lt2_maxwatt = 0

lt3_device  = 
lt3_address = 1
lt3_maxwatt = 0

##########################################################################
# Here you specify your main parameter for charging
# The meanwell min/max paramter are already stored in the mwcan.ini, 
# can can not be changed here 
##########################################################################

#IMPROTANT: ALL VOLTAGES AND CURRENT IS NEEDED IN (VALUE) * 100 !!! 
#e.g. 3,45V * 100 = 345 or 25A = 25*100 = 2500
#For setup paramaters make sure you measure the voltage with a good multimeter, e.g. the MW has a +/- value
#Specify then the exact current and voltage you want to use 

#How much Cells do you have in your Battery  
CellCount              = 8

#Max cell voltage for caculation of max battery Chargevoltage (e.g. 8 cells * 3,45V = 27,60 --> 8 * 345 = 2760) 
#Max voltage for charing the battery
#Common is 3,45V, MAX is 3,65V ! 
CellvoltageMax         = 345

#Restart cell voltage for restart the chagring (e.g. 8*331 = 2648 = 26,48) 
#Should be (a bit) lower than CellvoltageMax 
#When the charger stoped charing because of low current, 
#this value defines when charging is allowed again
#Voltage drop after stop charging
CellvoltageMaxRestart  = 331     

#Min cell voltage for caculation of min Battery voltage (e.g. 8*305 = 2440 = 24,40V) 
#mainly done via BMS SOC check but normally not very exact. 
#you should use the voltage as better indicator 
#e.g. 3,01V, MIN is 2,50V ! 
CellvoltageMin         = 305

#Restart cell voltage for restart the dischagring (e.g. 8*313 = 2504 = 25,04V) 
#Needs to be higher than  CellvoltageMin
#When the Discharger stoped discharing because of low voltage, 
#this value defines when discharging is allowed again, bcause the Cell Voltage raises after stop discharging
CellvoltageMinRestart  = 320

#Current *100 --> 25,0A * 100 = 2500
#Can be the maximum of the device or a lower value
MaxChargeCurrent          = 3600  

#Current *100  --> 7,2A * 100 = 720
#Can be the minmum of the device or a higher value 
MinChargeCurrent          =  720  

#Current *100  --> 5,0A * 100 = 500
#Should be a lower value than the minmum of the device 
#When should the charger stop charing and assum the Battery is full
#Normally if the chargcurrent gets lower than MinChargeCurrent
#You can still charge the Battery (like float) until STOP current is reached
#Set to 0 if you do not want to stop 
StopMinChargeCurrent          =  100  

#Current *100
#Can be the minmum of the device or a higher value 
MinDisChargeCurrent       =   90  

#Current *100
#Can be the maximum of the device or a lower value 
MaxDischargeCurrent       = 8000  

#how much power diffrence is OK
#not used now
ChargerCurrentDiffHyst    =    0   

#how much current (A) is allowed before start discharge in *100 notation, e.g 0.1A = 10 (0.1A * 230V = 23W)
DisChargerCurrentMin      =   10   

##########################################################################
# Meanwell parameters ####################################################
##########################################################################
# CAN ID from the Device, set up by jumper on the device
# BIC-2200 --> 00 to 07, all open = 07
# NPM-abc0 --> 00 to 03, all open = 03
USEDID = 03

#Voltage in from Grid correction, NPB hat +/- 10V, you should check it with voltmeter and set the diffrence (with "-" if negative)
Voltage_ACIN_correction     =   -9  

# Meanwell counter for changes. READ ONLY !!
MW_EEPROM_COUNTER = 0

